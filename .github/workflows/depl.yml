name: Deploy to GitHub Pages
run-name: ${{ github.actor }} is testing ${{ github.ref }}

on:
  push:
    branches: [ main, dev, test ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref_name }}"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v3
        
      - name: Determine deployment path
        id: deployment-path
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "path=." >> $GITHUB_OUTPUT
            echo "url_suffix=" >> $GITHUB_OUTPUT
          else
            echo "path=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "url_suffix=/${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create directory structure
        run: |
          if [[ "${{ github.ref_name }}" != "main" ]]; then
            mkdir -p ${{ github.ref_name }}
            cp -r * ${{ github.ref_name }}/ 2>/dev/null || true
            # Remove the branch directory from itself to avoid recursion
            rm -rf ${{ github.ref_name }}/${{ github.ref_name }} 2>/dev/null || true
            # Remove .github directory from branch folder
            rm -rf ${{ github.ref_name }}/.github 2>/dev/null || true
          fi
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ${{ steps.deployment-path.outputs.path }}
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

  notify:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "ðŸš€ Main branch deployed to: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          else
            echo "ðŸš€ ${{ github.ref_name }} branch deployed to: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.ref_name }}/"
          fi
